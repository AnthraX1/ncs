/*  Last Modify  2004/06/05  */#define PAS_SRCFILE    3101#include <stdio.h>#include <time.h>#include <stdlib.h>#include <errno.h>#include <string.h>#include <sys/time.h>#include "utoall.h"#include "ncsdef.h"#include "pasutl.h"#include "pasdb.h"#include "pasmessage.h"#include "ncapi.h"#include "ncmac.h"#include <time.h>#include <malloc.h>#include <pthread.h>#include "string.h"#include <stdlib.h>#include <sys/stat.h>#include <sys/types.h>#define MAX_TIMEOUT_SECONDS (15*60)static int macPrint(long isDebug, const char* fmt, ...){    int retCnt = 0;    if(isDebug)    {        va_list ap;        va_start(ap, fmt);        retCnt = vprintf(fmt, ap);        va_end(ap);    }    return retCnt;}/* 显示增加/修改用户的界面  *//*int ncsWebDispClientAddForm_wif_v9(utShmHead *psShmHead, int iFd,utMsgHead *psMsgHead){    pasDbCursor *psCur;    char caIp[34],caMac[64],caAddtime[16];    char caUserid[32];    char caUsername[34],caHandphone[32];    char caEmail[127],caLasttime[16];    char caPassword[32];    char caCond[32],caGroupid[16];    char caContact[32],caTelphone[32],caAddress[128];    int iNum1;    long lUse;    unsigned long lUserid,lGroupid,lGroupid0;    utPltDbHead *psDbHead;    int iReturn;    int iModFlags;    char caSmt[256];    char *pBuf,*pSelect;    char  caUse[16];    unsigned long lTime;    char caDispname[64],groupname[32];    ncsClient *psClient;    char caTemp[128];    int iNum=0;    unsigned int groupid=0;    int gtype=0;    char sqlbuf[4048]="";    char caGroupcode[32];    char handphone[36],servicecode[16],postcode[10],servicestate[12],ceoname[32],areaman[32];    char joincode[10],empnum[10],area[72],areatel[32],demo[256],ip[18],servernum[14],endnum[10],jointype[10];    int useflags,userid;    char caLongitude[16],caLatitude[16];    char servernum1[8],postcode1[16],caEmail1[127];    char disflag[8];    char caPlate[128];    char servicestate_choice[16]="selected";    char join_type_choice[15]="sel";    long lMonflag=0;    char caAreacodeToUser[32];   char caFcode[16],caName[68];    char caGroups[1024];    char caFacs[1024];   long lDateid;   double fLongitude,fLatitude;   long lJytype;   char caCeoidtype[8],caCeocardid[32],caCeotel[64],caSdate[20],caEdate[20],caPort_start[20],caPort_end[20],caJytype[8],caCeltel[32];   long lWorkflag,lYyflag;   long llGroupId = 0;    //获取权限组ID和接入厂商    strcpy(caFacs,getDsFacGroupid());    strcpy(caGroups,getDsGroupid());   strcpy(caAreacodeToUser,utComGetVar_sd(psShmHead,"AreacodeToUser","No"));    psDbHead = utPltInitDb();     sprintf(sqlbuf,"select groupid,groupname,groupcode from ncsgroup where 1=1 ");    if(strlen(caGroups)>0){        sprintf(sqlbuf+strlen(sqlbuf)," and groupid in (%s) ",caGroups);    }    sprintf(sqlbuf+strlen(sqlbuf)," order by groupid desc");    psCur = pasDbOpenSql(sqlbuf,0);    iReturn = pasDbFetchInto(psCur,                                       UT_TYPE_ULONG,4,&groupid,                                       UT_TYPE_STRING,31,groupname,                                       UT_TYPE_STRING,16,caGroupcode);    iNum = 0;    while((iReturn==0)||(iReturn==1405))    {        iNum++;        utPltPutLoopVarF(psDbHead,"groupid",   iNum,"%lu",groupid);        utPltPutLoopVar(psDbHead,"groupname",iNum,groupname);        utPltPutLoopVar(psDbHead,"groupcode",iNum,caGroupcode);        memset(caGroupcode,0,sizeof(caGroupcode));        iReturn = pasDbFetchInto(psCur,                                       UT_TYPE_ULONG,4,&groupid,                                       UT_TYPE_STRING,31,groupname,                                       UT_TYPE_STRING,16,caGroupcode);    }    pasDbCloseCursor(psCur);  //接入厂商    sprintf(sqlbuf,"select code,name from ncsfactorycod where 1=1 ");    if(strlen(caFacs)>0){        sprintf(sqlbuf+strlen(sqlbuf)," and code in (%s)",caFacs);    }    psCur = pasDbOpenSql(sqlbuf,0);    memset(caFcode,0,sizeof(caFcode));    memset(caName,0,sizeof(caName));    iReturn = pasDbFetchInto(psCur,UT_TYPE_STRING,10,caFcode,                                   UT_TYPE_STRING,60,caName);    iNum = 0;    while((iReturn==0)||(iReturn==1405))    {        if(iNum==0){strcpy(caFacs,caFcode);}        iNum++;        utPltPutLoopVar(psDbHead,"fcod",   iNum,caFcode);        utPltPutLoopVar(psDbHead,"fname",iNum,caName);            memset(caFcode,0,sizeof(caFcode));            memset(caName,0,sizeof(caName));            iReturn = pasDbFetchInto(psCur,UT_TYPE_STRING,10,caFcode,                                           UT_TYPE_STRING,60,caName);    }    pasDbCloseCursor(psCur);    sprintf(sqlbuf,"select code,name from ncsuser_lb where 1=1 ");        psCur = pasDbOpenSql(sqlbuf,0);            if(psCur == NULL) {                  utWebDispMsg(iFd,psMsgHead,"ncs/ncmsg_back.htm","部门查询","数据库出错");        //        free(pHash);                return 0;            }           char caCode[16];         memset(caName,0,sizeof(caName));       memset(caCode,0,sizeof(caCode));           iReturn = pasDbFetchInto(psCur,UT_TYPE_STRING,10,caCode,                                          UT_TYPE_STRING,63,caName);           iNum=0;            while(iReturn == 0||iReturn==1405) {                 if(iNum>0){                    utPltPutLoopVar(psDbHead,"dh",iNum+1,",");                 }                 iNum++;                 utPltSetCvtHtml(1);                       utPltPutLoopVarF(psDbHead,"lbname",iNum,"%s",caName);                 utPltSetCvtHtml(0);                 utPltPutLoopVarF(psDbHead,"lbcode",   iNum,"%s",caCode);                 if(gtype==atol(caCode)){                    utPltPutLoopVar(psDbHead,"check",iNum,",checked:true");                }         memset(caName,0,sizeof(caName));       memset(caCode,0,sizeof(caCode));           iReturn = pasDbFetchInto(psCur,UT_TYPE_STRING,10,caCode,                                          UT_TYPE_STRING,63,caName);            }            pasDbCloseCursor(psCur);    iReturn = utMsgGetSomeNVar(psMsgHead,5,          "groupid", UT_TYPE_STRING, 15, caGroupid,                    "userid",  UT_TYPE_STRING, 15, caUserid,                    "cond",    UT_TYPE_STRING, 31, caCond,                    "disflag", UT_TYPE_STRING,2,disflag,                    "plate",UT_TYPE_STRING,100,caPlate);    iModFlags = 0; //   lUserid = atol(caUserid);    lUserid=strtoul(caUserid,NULL,10);     printf("caUserid=%s,userid=%lu\n",caUserid,lUserid);    lTime = time(0);    if(!utStrIsSpaces(caUserid)) {        iModFlags = 1;    //    lUserid = atol(caUserid);        userid=0;        memset(caUsername,0,sizeof(caUsername));        memset(caPassword,0,sizeof(caPassword));        lGroupid=0;        memset(caDispname,0,sizeof(caDispname));        memset(caAddress,0,sizeof(caAddress));        memset(caTelphone,0,sizeof(caTelphone));        memset(caContact,0,sizeof(caContact));        memset(handphone,0,sizeof(handphone));        memset(caEmail,0,sizeof(caEmail));        memset(ip,0,sizeof(ip));        memset(caAddtime,0,sizeof(caAddtime));        useflags=0;        memset(caLasttime,0,sizeof(caLasttime));        gtype=0;        memset(servicestate,0,sizeof(servicestate));        memset(joincode,0,sizeof(joincode));        memset(endnum,0,sizeof(endnum));        memset(servernum,0,sizeof(servernum));        memset(jointype,0,sizeof(jointype));        memset(empnum,0,sizeof(empnum));        memset(area,0,sizeof(area));        memset(areaman,0,sizeof(areaman));        memset(areatel,0,sizeof(areatel));        memset(demo,0,sizeof(demo));        memset(servicecode,0,sizeof(servicecode));        memset(postcode,0,sizeof(postcode));        memset(ceoname,0,sizeof(ceoname));       memset(caEmail1,0,sizeof(caEmail1));       memset(servicestate,0,sizeof(servicestate));       memset(endnum,0,sizeof(endnum));       memset(servernum1,0,sizeof(servernum1));       memset(ip,0,sizeof(ip));       memset(postcode1,0,sizeof(postcode1));       memset(caLasttime,0,sizeof(caLasttime));       memset(caFcode,0,sizeof(caFcode));       lDateid=0;       lMonflag=0;       lJytype=0;       memset(caCeoidtype,0,sizeof(caCeoidtype));       memset(caCeocardid,0,sizeof(caCeocardid));       memset(caSdate,0,sizeof(caSdate));       memset(caEdate,0,sizeof(caEdate));       memset(caPort_start,0,sizeof(caPort_start));       memset(caPort_end,0,sizeof(caPort_end));       lWorkflag=0;       lYyflag=0;        sprintf(sqlbuf,"select userid,username,password,groupid,dispname,address,\                               telphone,contact,handphone,addtime,useflags,gtype,joincode,\                               jointype,empnum,area,areaman,areatel,demo,\                               ceoname,endnum,servernum,postcode,email,servicestate,ip,lasttime,monflag,fcode,dateid,longitude,latitude,\                               jytype,ceoidtype,ceocardid,ceotel,sdate,edate,port_start,port_end,workflag,yyflag from ncsuser where userid=%lu",lUserid);       printf("sqlbuf=%s\n",sqlbuf);      memset(caLongitude,0,sizeof(caLongitude));      memset(caLatitude,0,sizeof(caLatitude));        iReturn = pasDbOneRecord(sqlbuf,                            0,                            UT_TYPE_LONG,4,&userid,                            UT_TYPE_STRING,31, caUsername,                            UT_TYPE_STRING,31, caPassword,                            UT_TYPE_LONG,4,&lGroupid,                            UT_TYPE_STRING,63, caDispname,                            UT_TYPE_STRING,127,caAddress,                            UT_TYPE_STRING,63, caTelphone,                            UT_TYPE_STRING,31, caContact,                            UT_TYPE_STRING,31,handphone,                            UT_TYPE_STRING,16,caAddtime,                            UT_TYPE_LONG,4,&useflags,                            UT_TYPE_LONG,4,&gtype,                            UT_TYPE_STRING,10,joincode,                            UT_TYPE_STRING,10,jointype,                            UT_TYPE_STRING,10,empnum,                            UT_TYPE_STRING,70,area,                            UT_TYPE_STRING,70,areaman,                            UT_TYPE_STRING,30,areatel,                            UT_TYPE_STRING,255,demo,                            UT_TYPE_STRING,30,ceoname,                            UT_TYPE_STRING,6,endnum,                            UT_TYPE_STRING,2,servernum1,                            UT_TYPE_STRING,6,postcode1,                            UT_TYPE_STRING,127,caEmail1,                            UT_TYPE_STRING,2,servicestate,                            UT_TYPE_STRING,16,ip,                            UT_TYPE_STRING,16,caLasttime,                            UT_TYPE_LONG,4,&lMonflag,                            UT_TYPE_STRING,10,caFcode,                            UT_TYPE_LONG,4,&lDateid,                            UT_TYPE_STRING,12,caLongitude,                            UT_TYPE_STRING,12,caLatitude,                            UT_TYPE_LONG,4,&lJytype,                            UT_TYPE_STRING,sizeof(caCeoidtype)-1,caCeoidtype,                            UT_TYPE_STRING,sizeof(caCeocardid)-1,caCeocardid,                            UT_TYPE_STRING,sizeof(caCeltel)-1,caCeltel,                            UT_TYPE_STRING,sizeof(caSdate)-1,caSdate,                            UT_TYPE_STRING,sizeof(caEdate)-1,caEdate,                            UT_TYPE_STRING,sizeof(caPort_start)-1,caPort_start,                            UT_TYPE_STRING,sizeof(caPort_end)-1,caPort_end,                            UT_TYPE_LONG,4,&lWorkflag,                            UT_TYPE_LONG,4,&lYyflag);     if(iReturn != 0 && iReturn != PAS_DB_NULLVALUE) {            utPltFreeDb(psDbHead);            utWebDispMsg(iFd,psMsgHead,"nc/ncmsg_back.htm","修改用户","用户不存在 %d ",iReturn);           return 0;      }    else{          utPltPutVar(psDbHead,"userid",    caUserid);          utPltPutVar(psDbHead,"username",  caUsername);          utPltPutVar(psDbHead,"dispname",  caDispname); //单位名称//          printf("gtype=%d\n",gtype);//          printf("lGroupid=%d\n",lGroupid);          utPltPutVarF(psDbHead,"groupid","%lu",lGroupid);//所属组            llGroupId = lGroupid;          utPltPutVarF(psDbHead,"gtype","%lu",gtype); //公司类型          utPltPutVar(psDbHead,"servicestate",servicestate);//服务状态          utPltPutVar(psDbHead,"endnum",endnum);          utPltPutVar(psDbHead,jointype,jointype);//接入类型          utPltPutVar(psDbHead,"end_num",endnum);          utPltPutVar(psDbHead,"servernum",servernum1);          utPltPutVar(psDbHead,"postcode",postcode1);          utPltPutVar(psDbHead,"email_addr",caEmail1);          utPltPutVar(psDbHead,"joincode",joincode);          utPltPutVar(psDbHead,"servicecode",servicecode);          utPltPutVar(psDbHead,"address", caAddress);          utPltPutVar(psDbHead,"ceoname",ceoname);          utPltPutVar(psDbHead,"handphone",handphone);          utPltPutVar(psDbHead,"contact", caContact);          utPltPutVar(psDbHead,"telphone",caTelphone);          utPltPutVar(psDbHead,"empnum",empnum);          utPltPutVar(psDbHead,"area",area);          utPltPutVar(psDbHead,"areaman",areaman);          utPltPutVar(psDbHead,"areatel",areatel);          utPltPutVar(psDbHead,"entrance_ip", ip);          utPltPutVar(psDbHead,"jointype",jointype);          utPltPutVar(psDbHead,"fcode",caFcode);          utPltPutVarF(psDbHead,"dateid","%d",lDateid);          utPltPutVarF(psDbHead,"longitude","%s",caLongitude);          utPltPutVarF(psDbHead,"latitude","%s",caLatitude);           psClient =  (ncsClient *)ncsUtlGetClientById(psShmHead,atol(caUserid));           if(psClient){              if(psClient->status==1)                utPltPutVar(psDbHead,"userflags","正常");              else if(psClient->status==3){                sprintf(caTemp,"异常在线:%s",psClient->caMsg);                utPltPutVar(psDbHead,"userflags",caTemp);              }              else if(psClient->status==2){                utPltPutVar(psDbHead,"userflags","离线");              }          }          utPltPutVar(psDbHead,"addtime", caAddtime);          utPltPutVar(psDbHead,"lasttime", caLasttime);          utPltPutVarF(psDbHead,"monflag","%lu",lMonflag);          utPltPutVarF(psDbHead,"jytype","%d",lJytype);          utPltPutVar(psDbHead,"ceoidtype",caCeoidtype);          utPltPutVar(psDbHead,"ceocardid",caCeocardid);          utPltPutVar(psDbHead,"sdate",caSdate);          utPltPutVar(psDbHead,"edate",caEdate);          utPltPutVar(psDbHead,"port_start",caPort_start);          utPltPutVar(psDbHead,"port_end",caPort_end);          utPltPutVarF(psDbHead,"workflag","%d",lWorkflag);          utPltPutVarF(psDbHead,"yyflag","%d",lYyflag);          utPltSetCvtHtml(1);          utPltPutVar(psDbHead,"demo",demo);//备注          utPltSetCvtHtml(0);  //        printf("demo=%s\n",demo);          if(strncmp(caPassword,"***",3)!=0 && strncmp(caPassword,"@@@",3)!=0) {                utPltPutVar(psDbHead,"password", "********");            }    }  }    else {          utPltPutVar(psDbHead,"sdate","08:00");          utPltPutVar(psDbHead,"edate","18:00");        strcpy(caAddtime,utTimFormat("%Y-%m-%d %H:%M:%S",lTime));        utPltPutVar(psDbHead,"addtime", caAddtime);        utPltPutVar(psDbHead,"lasttime",caAddtime);        if(strlen(caGroupid)!=0)        utPltPutVar(psDbHead,"groupid",caGroupid);        else        utPltPutVar(psDbHead,"groupid","0");        utPltPutVar(psDbHead,"qtcheck",",checked:true");        utPltPutVar(psDbHead,"servicestate","1");//服务状态        utPltPutVar(psDbHead,"jointype","99");//接入类型        utPltPutVar(psDbHead,"monflag","0");        utPltPutVar(psDbHead,"end_num","0");        utPltPutVar(psDbHead,"servernum","0");          utPltPutVarF(psDbHead,"workflag","%d",0);          utPltPutVarF(psDbHead,"yyflag","%d",0);          utPltPutVar(psDbHead,"fcode",caFacs);    }    unsigned long lPid;     utPltPutVarF(psDbHead,"llGroupId","%lu",llGroupId);    sprintf(caTemp,"select pid from ncsgroup where groupid = %lu",llGroupId);    pasDbOneRecord(caTemp,0,UT_TYPE_LONG,4,&lPid);    utPltPutVarF(psDbHead,"pid","%lu",lPid);    if(strlen(caPlate)>0){        utPltOutToHtml(iFd,psMsgHead,psDbHead,caPlate);    }    else{        utPltOutToHtml(iFd,psMsgHead,psDbHead,"v4/nc_form_clientedit.htm");    }    return 0;}*/int ncsWebDispClientAddForm_wif_v9(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    pasDbCursor *psCur;    char caIp[34], caMac[64], caAddtime[16];    char caUserid[32];    char caUsername[34], caHandphone[32];    char caEmail[127], caLasttime[16];    char caPassword[32];    char caCond[32], caGroupid[16];    char caContact[32], caTelphone[32], caAddress[128];    int iNum1;    long lUse;    unsigned long lUserid, lGroupid, lGroupid0;    utPltDbHead *psDbHead;    int iReturn;    int iModFlags;    char caSmt[256];    char *pBuf, *pSelect;    char  caUse[16];    unsigned long lTime;    char caDispname[64], groupname[32];    ncsClient *psClient;    char caTemp[128];    int iNum = 0;    unsigned int groupid = 0;    int gtype = 0;    char sqlbuf[4048] = "";    char caGroupcode[32];    char handphone[36], servicecode[16], postcode[10], servicestate[12], ceoname[32], areaman[32];    char joincode[10], empnum[10], area[72], areatel[32], demo[256], ip[18], servernum[14], endnum[10], jointype[10];    int useflags, userid;    char caLongitude[16], caLatitude[16];    char servernum1[8], postcode1[16], caEmail1[127];    char disflag[8];    char caPlate[128];    char servicestate_choice[16] = "selected";    char join_type_choice[15] = "sel";    long lMonflag = 0;    char caAreacodeToUser[32];    char caFcode[16], caName[68];    char caGroups[1024];    char caFacs[1024];    long lDateid;    double fLongitude, fLatitude;    long lJytype;    char caCeoidtype[8], caCeocardid[32], caCeotel[64], caSdate[20], caEdate[20], caPort_start[20], caPort_end[20], caJytype[8], caCeltel[32];    long lWorkflag, lYyflag;    //获取权限组ID和接入厂商    strcpy(caFacs, getDsFacGroupid());    strcpy(caGroups, getDsGroupid());    strcpy(caAreacodeToUser, utComGetVar_sd(psShmHead, "AreacodeToUser", "No"));    psDbHead = utPltInitDb();    sprintf(sqlbuf, "select groupid,groupname,groupcode from ncsgroup where 1=1 ");    if(strlen(caGroups) > 0)    {        sprintf(sqlbuf + strlen(sqlbuf), " and groupid in (%s) ", caGroups);    }    sprintf(sqlbuf + strlen(sqlbuf), " order by groupid desc");    psCur = pasDbOpenSql(sqlbuf, 0);    iReturn = pasDbFetchInto(psCur,                             UT_TYPE_ULONG, 4, &groupid,                             UT_TYPE_STRING, 31, groupname,                             UT_TYPE_STRING, 16, caGroupcode);    iNum = 0;    while((iReturn == 0) || (iReturn == 1405))    {        iNum++;        utPltPutLoopVarF(psDbHead, "groupid",   iNum, "%lu", groupid);        utPltPutLoopVar(psDbHead, "groupname", iNum, groupname);        utPltPutLoopVar(psDbHead, "groupcode", iNum, caGroupcode);        memset(caGroupcode, 0, sizeof(caGroupcode));        iReturn = pasDbFetchInto(psCur,                                 UT_TYPE_ULONG, 4, &groupid,                                 UT_TYPE_STRING, 31, groupname,                                 UT_TYPE_STRING, 16, caGroupcode);    }    pasDbCloseCursor(psCur);    //接入厂商    sprintf(sqlbuf, "select code,name from ncsfactorycod where 1=1 ");    if(strlen(caFacs) > 0)    {        sprintf(sqlbuf + strlen(sqlbuf), " and code in (%s)", caFacs);    }    psCur = pasDbOpenSql(sqlbuf, 0);    memset(caFcode, 0, sizeof(caFcode));    memset(caName, 0, sizeof(caName));    iReturn = pasDbFetchInto(psCur, UT_TYPE_STRING, 10, caFcode,                             UT_TYPE_STRING, 60, caName);    iNum = 0;    while((iReturn == 0) || (iReturn == 1405))    {        if(iNum == 0)        {            strcpy(caFacs, caFcode);        }        iNum++;        utPltPutLoopVar(psDbHead, "fcod",   iNum, caFcode);        utPltPutLoopVar(psDbHead, "fname", iNum, caName);        memset(caFcode, 0, sizeof(caFcode));        memset(caName, 0, sizeof(caName));        iReturn = pasDbFetchInto(psCur, UT_TYPE_STRING, 10, caFcode,                                 UT_TYPE_STRING, 60, caName);    }    pasDbCloseCursor(psCur);    sprintf(sqlbuf, "select code,name from ncsuser_lb where 1=1 ");    psCur = pasDbOpenSql(sqlbuf, 0);    if(psCur == NULL)    {        utWebDispMsg(iFd, psMsgHead, "ncs/ncmsg_back.htm", "部门查询", "数据库出错");        //        free(pHash);        return 0;    }    char caCode[16];    memset(caName, 0, sizeof(caName));    memset(caCode, 0, sizeof(caCode));    iReturn = pasDbFetchInto(psCur, UT_TYPE_STRING, 10, caCode,                             UT_TYPE_STRING, 63, caName);    iNum = 0;    while(iReturn == 0 || iReturn == 1405)    {        if(iNum > 0)        {            utPltPutLoopVar(psDbHead, "dh", iNum + 1, ",");        }        iNum++;        utPltSetCvtHtml(1);        utPltPutLoopVarF(psDbHead, "lbname", iNum, "%s", caName);        utPltSetCvtHtml(0);        utPltPutLoopVarF(psDbHead, "lbcode",   iNum, "%s", caCode);        if(gtype == atol(caCode))        {            utPltPutLoopVar(psDbHead, "check", iNum, ",checked:true");        }        memset(caName, 0, sizeof(caName));        memset(caCode, 0, sizeof(caCode));        iReturn = pasDbFetchInto(psCur, UT_TYPE_STRING, 10, caCode,                                 UT_TYPE_STRING, 63, caName);    }    pasDbCloseCursor(psCur);    iReturn = utMsgGetSomeNVar(psMsgHead, 5,                               "groupid", UT_TYPE_STRING, 15, caGroupid,     /* 位置  */                               "userid",  UT_TYPE_STRING, 15, caUserid,                               "cond",    UT_TYPE_STRING, 31, caCond,                               "disflag", UT_TYPE_STRING, 2, disflag,                               "plate", UT_TYPE_STRING, 100, caPlate);    iModFlags = 0;    //   lUserid = atol(caUserid);    lUserid = strtoul(caUserid, NULL, 10);    printf("caUserid=%s,userid=%lu\n", caUserid, lUserid);    lTime = time(0);    if(!utStrIsSpaces(caUserid))    {        iModFlags = 1;        //    lUserid = atol(caUserid);        userid = 0;        memset(caUsername, 0, sizeof(caUsername));        memset(caPassword, 0, sizeof(caPassword));        lGroupid = 0;        memset(caDispname, 0, sizeof(caDispname));        memset(caAddress, 0, sizeof(caAddress));        memset(caTelphone, 0, sizeof(caTelphone));        memset(caContact, 0, sizeof(caContact));        memset(handphone, 0, sizeof(handphone));        memset(caEmail, 0, sizeof(caEmail));        memset(ip, 0, sizeof(ip));        memset(caAddtime, 0, sizeof(caAddtime));        useflags = 0;        memset(caLasttime, 0, sizeof(caLasttime));        gtype = 0;        memset(servicestate, 0, sizeof(servicestate));        memset(joincode, 0, sizeof(joincode));        memset(endnum, 0, sizeof(endnum));        memset(servernum, 0, sizeof(servernum));        memset(jointype, 0, sizeof(jointype));        memset(empnum, 0, sizeof(empnum));        memset(area, 0, sizeof(area));        memset(areaman, 0, sizeof(areaman));        memset(areatel, 0, sizeof(areatel));        memset(demo, 0, sizeof(demo));        memset(servicecode, 0, sizeof(servicecode));        memset(postcode, 0, sizeof(postcode));        memset(ceoname, 0, sizeof(ceoname));        memset(caEmail1, 0, sizeof(caEmail1));        memset(servicestate, 0, sizeof(servicestate));        memset(endnum, 0, sizeof(endnum));        memset(servernum1, 0, sizeof(servernum1));        memset(ip, 0, sizeof(ip));        memset(postcode1, 0, sizeof(postcode1));        memset(caLasttime, 0, sizeof(caLasttime));        memset(caFcode, 0, sizeof(caFcode));        lDateid = 0;        lMonflag = 0;        lJytype = 0;        memset(caCeoidtype, 0, sizeof(caCeoidtype));        memset(caCeocardid, 0, sizeof(caCeocardid));        memset(caSdate, 0, sizeof(caSdate));        memset(caEdate, 0, sizeof(caEdate));        memset(caPort_start, 0, sizeof(caPort_start));        memset(caPort_end, 0, sizeof(caPort_end));        lWorkflag = 0;        lYyflag = 0;        sprintf(sqlbuf, "select userid,username,password,groupid,dispname,address,\                               telphone,contact,handphone,addtime,useflags,gtype,joincode,\                               jointype,empnum,area,areaman,areatel,demo,\                               ceoname,endnum,servernum,postcode,email,servicestate,ip,lasttime,monflag,fcode,dateid,longitude,latitude,\                               jytype,ceoidtype,ceocardid,ceotel,sdate,edate,port_start,port_end,workflag,yyflag from ncsuser where userid=%lu", lUserid);        printf("sqlbuf=%s\n", sqlbuf);        memset(caLongitude, 0, sizeof(caLongitude));        memset(caLatitude, 0, sizeof(caLatitude));        iReturn = pasDbOneRecord(sqlbuf,                                 0,                                 UT_TYPE_LONG, 4, &userid,                                 UT_TYPE_STRING, 31, caUsername,                                 UT_TYPE_STRING, 31, caPassword,                                 UT_TYPE_LONG, 4, &lGroupid,                                 UT_TYPE_STRING, 63, caDispname,                                 UT_TYPE_STRING, 127, caAddress,                                 UT_TYPE_STRING, 63, caTelphone,                                 UT_TYPE_STRING, 31, caContact,                                 UT_TYPE_STRING, 31, handphone,                                 UT_TYPE_STRING, 16, caAddtime,                                 UT_TYPE_LONG, 4, &useflags,                                 UT_TYPE_LONG, 4, &gtype,                                 UT_TYPE_STRING, 10, joincode,                                 UT_TYPE_STRING, 10, jointype,                                 UT_TYPE_STRING, 10, empnum,                                 UT_TYPE_STRING, 70, area,                                 UT_TYPE_STRING, 70, areaman,                                 UT_TYPE_STRING, 30, areatel,                                 UT_TYPE_STRING, 255, demo,                                 UT_TYPE_STRING, 30, ceoname,                                 UT_TYPE_STRING, 6, endnum,                                 UT_TYPE_STRING, 2, servernum1,                                 UT_TYPE_STRING, 6, postcode1,                                 UT_TYPE_STRING, 127, caEmail1,                                 UT_TYPE_STRING, 2, servicestate,                                 UT_TYPE_STRING, 16, ip,                                 UT_TYPE_STRING, 16, caLasttime,                                 UT_TYPE_LONG, 4, &lMonflag,                                 UT_TYPE_STRING, 10, caFcode,                                 UT_TYPE_LONG, 4, &lDateid,                                 UT_TYPE_STRING, 12, caLongitude,                                 UT_TYPE_STRING, 12, caLatitude,                                 UT_TYPE_LONG, 4, &lJytype,                                 UT_TYPE_STRING, sizeof(caCeoidtype) - 1, caCeoidtype,                                 UT_TYPE_STRING, sizeof(caCeocardid) - 1, caCeocardid,                                 UT_TYPE_STRING, sizeof(caCeltel) - 1, caCeltel,                                 UT_TYPE_STRING, sizeof(caSdate) - 1, caSdate,                                 UT_TYPE_STRING, sizeof(caEdate) - 1, caEdate,                                 UT_TYPE_STRING, sizeof(caPort_start) - 1, caPort_start,                                 UT_TYPE_STRING, sizeof(caPort_end) - 1, caPort_end,                                 UT_TYPE_LONG, 4, &lWorkflag,                                 UT_TYPE_LONG, 4, &lYyflag);        if(iReturn != 0 && iReturn != PAS_DB_NULLVALUE)        {            utPltFreeDb(psDbHead);            utWebDispMsg(iFd, psMsgHead, "nc/ncmsg_back.htm", "修改用户", "用户不存在 %d ", iReturn);            return 0;        }        else        {            utPltPutVar(psDbHead, "userid",    caUserid);            utPltPutVar(psDbHead, "username",  caUsername);            utPltPutVar(psDbHead, "dispname",  caDispname); //单位名称            //          printf("gtype=%d\n",gtype);            //          printf("lGroupid=%d\n",lGroupid);            utPltPutVarF(psDbHead, "groupid", "%lu", lGroupid); //所属组            utPltPutVarF(psDbHead, "gtype", "%lu", gtype); //公司类型            utPltPutVar(psDbHead, "servicestate", servicestate); //服务状态            utPltPutVar(psDbHead, "endnum", endnum);            utPltPutVar(psDbHead, jointype, jointype); //接入类型            utPltPutVar(psDbHead, "end_num", endnum);            utPltPutVar(psDbHead, "servernum", servernum1);            utPltPutVar(psDbHead, "postcode", postcode1);            utPltPutVar(psDbHead, "email_addr", caEmail1);            utPltPutVar(psDbHead, "joincode", joincode);            utPltPutVar(psDbHead, "servicecode", servicecode);            utPltPutVar(psDbHead, "address", caAddress);            utPltPutVar(psDbHead, "ceoname", ceoname);            utPltPutVar(psDbHead, "handphone", handphone);            utPltPutVar(psDbHead, "contact", caContact);            utPltPutVar(psDbHead, "telphone", caTelphone);            utPltPutVar(psDbHead, "empnum", empnum);            utPltPutVar(psDbHead, "area", area);            utPltPutVar(psDbHead, "areaman", areaman);            utPltPutVar(psDbHead, "areatel", areatel);            utPltPutVar(psDbHead, "entrance_ip", ip);            utPltPutVar(psDbHead, "jointype", jointype);            utPltPutVar(psDbHead, "fcode", caFcode);            utPltPutVarF(psDbHead, "dateid", "%d", lDateid);            utPltPutVarF(psDbHead, "longitude", "%s", caLongitude);            utPltPutVarF(psDbHead, "latitude", "%s", caLatitude);            psClient = (ncsClient *)ncsUtlGetClientById(psShmHead, atol(caUserid));            if(psClient)            {                if(psClient->status == 1)                    utPltPutVar(psDbHead, "userflags", "正常");                else if(psClient->status == 3)                {                    sprintf(caTemp, "异常在线:%s", psClient->caMsg);                    utPltPutVar(psDbHead, "userflags", caTemp);                }                else if(psClient->status == 2)                {                    utPltPutVar(psDbHead, "userflags", "离线");                }            }            utPltPutVar(psDbHead, "addtime", caAddtime);            utPltPutVar(psDbHead, "lasttime", caLasttime);            utPltPutVarF(psDbHead, "monflag", "%lu", lMonflag);            utPltPutVarF(psDbHead, "jytype", "%d", lJytype);            utPltPutVar(psDbHead, "ceoidtype", caCeoidtype);            utPltPutVar(psDbHead, "ceocardid", caCeocardid);            utPltPutVar(psDbHead, "sdate", caSdate);            utPltPutVar(psDbHead, "edate", caEdate);            utPltPutVar(psDbHead, "port_start", caPort_start);            utPltPutVar(psDbHead, "port_end", caPort_end);            utPltPutVarF(psDbHead, "workflag", "%d", lWorkflag);            utPltPutVarF(psDbHead, "yyflag", "%d", lYyflag);            utPltSetCvtHtml(1);            utPltPutVar(psDbHead, "demo", demo); //备注            utPltSetCvtHtml(0);            //        printf("demo=%s\n",demo);            if(strncmp(caPassword, "***", 3) != 0 && strncmp(caPassword, "@@@", 3) != 0)            {                utPltPutVar(psDbHead, "password", "********");            }        }    }    else    {        utPltPutVar(psDbHead, "sdate", "08:00");        utPltPutVar(psDbHead, "edate", "18:00");        strcpy(caAddtime, utTimFormat("%Y-%m-%d %H:%M:%S", lTime));        utPltPutVar(psDbHead, "addtime", caAddtime);        utPltPutVar(psDbHead, "lasttime", caAddtime);        if(strlen(caGroupid) != 0)            utPltPutVar(psDbHead, "groupid", caGroupid);        else            utPltPutVar(psDbHead, "groupid", "0");        utPltPutVar(psDbHead, "qtcheck", ",checked:true");        utPltPutVar(psDbHead, "servicestate", "1"); //服务状态        utPltPutVar(psDbHead, "jointype", "99"); //接入类型        utPltPutVar(psDbHead, "monflag", "0");        utPltPutVar(psDbHead, "end_num", "0");        utPltPutVar(psDbHead, "servernum", "0");        utPltPutVarF(psDbHead, "workflag", "%d", 0);        utPltPutVarF(psDbHead, "yyflag", "%d", 0);        utPltPutVar(psDbHead, "fcode", caFacs);    }    unsigned long lPid;    sprintf(caTemp, "select pid from ncsgroup where groupid = %lu", lGroupid);    pasDbOneRecord(caTemp, 0, UT_TYPE_LONG, 4, &lPid);    utPltPutVarF(psDbHead, "pid", "%lu", lPid);    if(strlen(caPlate) > 0)    {        utPltOutToHtml(iFd, psMsgHead, psDbHead, caPlate);    }    else    {        utPltOutToHtml(iFd, psMsgHead, psDbHead, "v4/nc_form_clientedit.htm");    }    return 0;}//单位树AJAX通讯int ncsTreeUser_v9_1(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    pasDbCursor *psCur;    char caLevel[16];    char caPlate[128];    char caGroupname[72], caGroupid[16];    char caTemp[4024];    char caName[32];    char caWhere[256];    char caCurPg[16], caTotRec[16];    char caPid[16];    unsigned long lLevel, lPid;    int  iNum;    char caFilter[256];    char caNo[16];    unsigned long lGroupid, lGroupid0, lCurPg, lTotRec, lRowNum, lStartRec;    utPltDbHead *psDbHead;    int iReturn, i;    char caVar[256], caFname[64], caBfname[64];    char caValue[256];    char caVar1[32];    char caOpt[256];    char caGroups[1024];    char caFacs[1024];    long lId;    char *p, *pVar;    unsigned char *pHash;    char caCname[72];    char caUsername[36];    pasLHashInfo  sHashInfo;    struct stData    {        unsigned long id;        unsigned long count;    };    long lCount;    struct stData *psData;    char caCname1[72];    char caSql[2048];    char caWireflag[20];    char caFaccods[1024];    long clientPid = atoi(caPid);#ifdef LDEBUG1    utMsgPrintMsg(psMsgHead);#endif    utMsgPrintMsg(psMsgHead);    strcpy(caGroups, getDsGroupid());    strcpy(caFacs, getDsFacGroupid());    printf("caFacs=%s\n", caFacs);    //      strcpy(caFaccods,getDsFacs()));    memset(caCname, 0, sizeof(caCname));    iReturn = utMsgGetSomeNVar(psMsgHead, 4,                               "node",        UT_TYPE_STRING, 10, caPid,                               "cname",       UT_TYPE_STRING, 30, caCname1,                               "plate",       UT_TYPE_STRING, 100, caPlate,                               "wireflag",    UT_TYPE_STRING, 10, caWireflag);    //部门    pHash = (unsigned char *)pasLHashInit(1000, 1000, sizeof(struct stData), 0, 4);    if(pHash == NULL) return 0;    psCur = pasDbOpenSql("select pid from ncsgroup where pid!=0 ", 0);    if(psCur)    {        iReturn = pasDbFetchInto(psCur, UT_TYPE_ULONG, 4, &lPid);        while(iReturn == 0)        {            psData = (struct stData *)pasLHashLookA(pHash, &lPid);            if(psData)            {                psData->count++;            }            iReturn = pasDbFetchInto(psCur, UT_TYPE_ULONG, 4, &lPid);        }        pasDbCloseCursor(psCur);    }    //单位    psCur = pasDbOpenSql("select distinct groupid from ncsuser  ", 0);    if(psCur)    {        iReturn = pasDbFetchInto(psCur, UT_TYPE_ULONG, 4, &lPid);        while(iReturn == 0)        {            psData = (struct stData *)pasLHashLookA(pHash, &lPid);            if(psData)            {                psData->count++;            }            iReturn = pasDbFetchInto(psCur, UT_TYPE_ULONG, 4, &lPid);        }        pasDbCloseCursor(psCur);    }    if(strlen(caCname1) > 0)    {        strcpy(caCname, pasCvtGBK(2, caCname1, caTemp, 30));    }    //    iReturn = dsCltGetSessionValue(1,"groupid",UT_TYPE_LONG,sizeof(long),&lGroupid0);    strcpy(caWhere, "\0");    memset(caOpt, 0, sizeof(caOpt));    iReturn = dsCltGetMyInfo(1, "Userid", &lId);    if(iReturn == 0)    {        pasDbOneRecord("select opt from dsuser where id=:id", 1, "id", UT_TYPE_LONG, lId, UT_TYPE_STRING, 255, caOpt);    }    lRowNum = utComGetVar_ld(psShmHead, "GroupTreeRow", 300);    iNum = 0;    psDbHead = utPltInitDb();    if(strlen(caCname) == 0)    {        lStartRec = (lCurPg - 1) * lRowNum;        sprintf(caTemp, "select groupname,groupid,pid from ncsgroup where 1=1 ");        if(strlen(caGroups) > 0)        {            if(strlen(caPid) == 0)            {                sprintf(caSql, "select pid from ncsgroup where pid not in (%s) and groupid in (%s) ", caGroups, caGroups);                lPid = 0;                pasDbOneRecord(caSql, 0, UT_TYPE_LONG, 4, &lPid);                sprintf(caPid, "%d", lPid);            }            sprintf(caTemp + strlen(caTemp), "and groupid in (%s) ", caGroups);        }        //      if(strlen(caFacs)>0){        //          sprintf(caTemp+strlen(caTemp)," and groupid in (%s) ",caFacs);        //      }        sprintf(caTemp + strlen(caTemp), " and pid=%d ", atol(caPid));        sprintf(caTemp + strlen(caTemp), " order by groupname limit %lu,%lu ", 0, lRowNum);        printf("caTemp=%s\n", caTemp);        psCur = pasDbOpenSql(caTemp, 0);        if(psCur == NULL)        {            utWebDispMsg(iFd, psMsgHead, "ncs/ncmsg_back.htm", "部门查询", "数据库出错");            //        free(pHash);            return 0;        }        memset(caGroupname, 0, sizeof(caGroupname));        lGroupid = 0;        lPid = 0;        iReturn = pasDbFetchInto(psCur, UT_TYPE_STRING, 68, caGroupname,                                 UT_TYPE_LONG, 4, &lGroupid,                                 UT_TYPE_LONG, 4, &lPid);        while(iReturn == 0)        {            psData = (struct stData *)pasLHashLook(pHash, &lGroupid);            if(psData)            {                if(iNum > 0)                {                    utPltPutLoopVar(psDbHead, "dh", iNum + 1, ",");                }                iNum++;                utPltSetCvtHtml(1);                utPltPutLoopVar(psDbHead, "groupname", iNum, utStrGetCharHan(caGroupname, 48));                utPltSetCvtHtml(0);                utPltPutLoopVarF(psDbHead, "groupid",   iNum, "%ld", lGroupid);                if(clientPid == lPid)                {                    utPltPutLoopVarF(psDbHead, "parentid", iNum, "%ld", lPid);                }                utPltPutLoopVar(psDbHead, "leaf", iNum, "false");                utPltPutLoopVar(psDbHead, "cls", iNum, "folder");                //      else{                //              utPltPutLoopVar(psDbHead,"leaf", iNum,"true");                //                utPltPutLoopVar(psDbHead,"cls", iNum,"folder");                //           }                utPltPutLoopVar(psDbHead, "dtype", iNum, "2");                utPltPutLoopVarF(psDbHead, "iNum", iNum, "%d", iNum - 1);                utPltPutLoopVarF(psDbHead, "pid", iNum, "%d", lPid);            }            memset(caGroupname, 0, sizeof(caGroupname));            lGroupid = 0;            lLevel = 0;            lPid = 0;            iReturn = pasDbFetchInto(psCur, UT_TYPE_STRING, 68, caGroupname,                                     UT_TYPE_LONG, 4, &lGroupid,                                     UT_TYPE_LONG, 4, &lPid);        }        pasDbCloseCursor(psCur);        //     free(pHash);        utPltPutVar(psDbHead, "rootname", utComGetVar_sd(psShmHead, "rootname", "全部单位"));    }    sprintf(caTemp, "select dispname,userid,groupid,username from ncsuser where 1=1 ");    if(strlen(caGroups) > 0)    {        sprintf(caTemp + strlen(caTemp), " and groupid in (%s) ", caGroups);    }    if(strlen(caFacs) > 0)    {        sprintf(caTemp + strlen(caTemp), " and fcode in (%s) ", caFacs);    }    if(strlen(caWireflag) > 0)    {        if(strcmp(caWireflag, "2") == 0)        {            sprintf(caTemp + strlen(caTemp), " and (jointype='08' or jointype='09') ");        }        else if(strcmp(caWireflag, "1") == 0)        {            sprintf(caTemp + strlen(caTemp), " and jointype!='08' ");        }    }    if(strlen(caCname) == 0)    {        if(strlen(caPid) == 0)        {            sprintf(caTemp + strlen(caTemp), " and groupid not in (select groupid from ncsgroup ) ");        }        else        {            sprintf(caTemp + strlen(caTemp), " and groupid=%d ", atol(caPid));        }    }    else    {        sprintf(caTemp + strlen(caTemp), "and (dispname like '%c%s%c' or username like '%c%s%c') ", '%', caCname, '%', '%', caCname, '%');    }    sprintf(caTemp + strlen(caTemp), " order by dispname limit %lu,%lu", 0, lRowNum);    printf("caTemp=%s\n", caTemp);    psCur = pasDbOpenSql(caTemp, 0);    if(psCur != NULL)    {        memset(caGroupname, 0, sizeof(caGroupname));        lGroupid = 0;        lPid = 0;        memset(caUsername, 0, sizeof(caUsername));        iReturn = pasDbFetchInto(psCur, UT_TYPE_STRING, 68, caGroupname,                                 UT_TYPE_LONG, 4, &lGroupid,                                 UT_TYPE_LONG, 4, &lPid,                                 UT_TYPE_STRING, 15, caUsername);        while(iReturn == 0)        {            if(iNum > 0)            {                utPltPutLoopVar(psDbHead, "dh", iNum + 1, ",");            }            iNum++;            utPltSetCvtHtml(1);            utPltPutLoopVar(psDbHead, "groupname", iNum, utStrGetCharHan(caGroupname, 48));            utPltSetCvtHtml(0);            utPltPutLoopVarF(psDbHead, "did",   iNum, "%ld", lGroupid);            utPltPutLoopVar(psDbHead, "leaf", iNum, "true");            utPltPutLoopVar(psDbHead, "cls", iNum, "file");            utPltPutLoopVar(psDbHead, "dtype", iNum, "0");            utPltPutLoopVar(psDbHead, "code", iNum, caUsername);            utPltPutLoopVarF(psDbHead, "iNum", iNum, "%d", iNum - 1);            utPltPutLoopVarF(psDbHead, "pid", iNum, "%d", lPid);            memset(caGroupname, 0, sizeof(caGroupname));            lGroupid = 0;            lLevel = 0;            lPid = 0;            memset(caUsername, 0, sizeof(caUsername));            iReturn = pasDbFetchInto(psCur, UT_TYPE_STRING, 68, caGroupname,                                     UT_TYPE_LONG, 4, &lGroupid,                                     UT_TYPE_LONG, 4, &lPid,                                     UT_TYPE_STRING, 15, caUsername);        }        pasDbCloseCursor(psCur);    }    // utPltShowDb(psDbHead);    free(pHash);    if(strlen(caPlate) > 0)    {        utPltOutToHtml(iFd, psMsgHead, psDbHead, caPlate);    }    else    {        utPltOutToHtml(iFd, psMsgHead, psDbHead, "v4/ncs_user_tree.htm");    }    return 0;}int macFrontPageRange_v9(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    long frontPageDebug = utComGetVar_ld(psShmHead, "FrontDebug", 0);    if(frontPageDebug)    {        utMsgPrintMsg(psMsgHead);    }    utPltDbHead *psDbHead;    char groupid[32] = "";    char range_type[32] = "";    char sql[8024] = "";    //char caServicecodes[8024] = "";    int iReturn = 0;    pasDbCursor *psCur;    char caGroupSql[8024] = "";    strcpy(caGroupSql, (char*)getDsGroupcodeSql("servicecode"));    iReturn = utMsgGetSomeNVar(psMsgHead, 2,                               "groupid",  UT_TYPE_STRING, sizeof(groupid) - 1, groupid,                               "range_type", UT_TYPE_STRING, sizeof(range_type) - 1, range_type);    macPrint(frontPageDebug, "[groupid=%s,range_type=%s]\n", groupid, range_type);    //strcpy(caServicecodes, getServicecodesByDids(psShmHead, getDsGroupids()));    //printf("caServicecodes=[%s]\n", caServicecodes);    //查询表里符合条件所有的点    long collect_number = 0;    long sumCount = 0;    uchar caServiceName[128] = "";    ncDeptinfo      *psDept;    //printf("macFrontPageRange_v9---");    if(strcmp(range_type, "security") == 0)    {        ncApSrvOnline *psOnline;        pasHashInfo     sHashInfo;        uchar *pHash;        pHash = utShmHashHead(psShmHead, NC_LNK_APSRVONLINE);        int isInServiceList;        if(pHash == NULL)        {            printf("NC_LNK_APSRVONLINE Memory Error \n");            return (-1);        }        long maxTimeoutSeconds = utComGetVar_ld(psShmHead, "MaxTimeoutSecs", MAX_TIMEOUT_SECONDS);        psOnline = (ncApSrvOnline *)pasHashFirst(pHash, &sHashInfo);        int tmpcount = 0;        char caApmac[8024] = "";        memset(caApmac, 0, sizeof(caApmac));        while(psOnline)        {            isInServiceList = 1;            if(strlen(caGroupSql) > 0)            {                if((strlen(psOnline->servicecode) > 0) && strstr(caGroupSql, psOnline->servicecode))                {                    isInServiceList = 1;                }                else                {                    isInServiceList = 0;                }            }            if(isInServiceList)            {                if(time(0) - psOnline->lasttime < maxTimeoutSeconds)                {                    if(tmpcount == 0)                    {                        if(strlen(psOnline->apname) > 0)                        {                            sprintf(caApmac , "'%s'" , psOnline->apname);                            tmpcount++;                        }                    }                    else                    {                        if(strlen(psOnline->apname) > 0)                        {                            sprintf(caApmac + strlen(caApmac), ",'%s'", psOnline->apname);                        }                    }                }            }            psOnline = (ncApSrvOnline *)pasHashNextS(&sHashInfo);        }        long lGroupid = 0;        memset(sql, 0, sizeof(sql));        sprintf(sql, "select ifnull(online,0) as online, ifnull(total,0) as total,B.name as apname from  (");        if(strlen(caGroupSql) == 0)        {            sprintf(sql + strlen(sql), "select  count(*) as online ,name from ncaplist a left join ncsfactorycod b on (fcode=b.code) where 1=1 ");        }        else        {            sprintf(sql + strlen(sql), "select count(*) as online ,name from ncaplist a left join ncsfactorycod b on (fcode=b.code) where 1=1 and servicecode  in (%s) ", caGroupSql);        }        sprintf(sql + strlen(sql), " and apname in ( %s) group by name ) A ", caApmac);        sprintf(sql + strlen(sql), " right join  ( select count(*) as total,name  from ncaplist a left join ncsfactorycod b on (fcode=b.code)  group by name ) B  on A.name=B.name order by online/total desc limit 5 ");        printf("%s\n", sql);        /*        if(strlen(caGroupSql) > 0)        {            sprintf(sql, "select count(groupid) as nn,groupid from ncsuser where username in (select description from nctermsysalarm where alarmcode='10007' and status=0 and %s) and groupid!=0 group by groupid  order by nn desc limit 5", getDsGroupcodeSql("description"));        }        else        {            sprintf(sql, "select count(groupid) as nn,groupid from ncsuser where username in (select description from nctermsysalarm where alarmcode='10007' and status=0) and groupid!=0 group by groupid  order by nn desc limit 5");        }*/        psDbHead = utPltInitDb();        long online = 0;        long total = 0;        char cadispname[64] = "";        psCur = pasDbOpenSql(sql, 0);        iReturn = pasDbFetchInto(psCur,                                 UT_TYPE_LONG, 4, &online,                                 UT_TYPE_LONG, 4, &total,                                 UT_TYPE_STRING, sizeof(cadispname) - 1, cadispname);        int iNum = 0;        printf("%lu----%lu\n", online, total);        while((iReturn == 0) || (iReturn == 1405))        {            float on_off = 1.0 * online / total;            sumCount += on_off;            iNum ++;            utPltPutLoopVarF(psDbHead, "collect_number", iNum, "%f", on_off);            utPltPutLoopVar(psDbHead, "collect_name", iNum, cadispname);            if(iNum > 1)            {                utPltPutLoopVar(psDbHead, "dh", iNum, ",");            }            iReturn = pasDbFetchInto(psCur,                                     UT_TYPE_LONG, 4, &online,                                     UT_TYPE_LONG, 4, &total,                                     UT_TYPE_STRING, sizeof(cadispname) - 1, cadispname);            printf("%lu----%lu\n", online, total);        }        pasDbCloseCursor(psCur);    }    else    {        //类型不对        utPltPutVar(psDbHead, "result", "2");//2代表类型不对        utPltOutToHtml(iFd, psMsgHead, psDbHead, "mac/frontPage/macCollectRange.htm");        return 1;    }    //返回数据给前端    utPltPutVar(psDbHead, "result", "1");    utPltPutVarF(psDbHead, "sumCount", "%lu", sumCount);    utPltOutToHtml(iFd, psMsgHead, psDbHead, "mac/frontPage/macCollectRange.htm");    return 0;}int procapAuditSetFun(utShmHead * psShmHead){    int iReturn;    pasSetTcpFunName("ncsWebDispClientAddForm_wif_v9", ncsWebDispClientAddForm_wif_v9, 0);    pasSetTcpFunName("macFrontPageRange_v9", macFrontPageRange_v9, 0);    pasSetTcpFunName("ncsTreeUser_v9_1", ncsTreeUser_v9_1, 0);    return 0;}